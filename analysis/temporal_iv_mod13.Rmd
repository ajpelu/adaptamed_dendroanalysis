---
title: "Temporal evolution of IV indexes from MODIS MOD13Q1"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set( 
                      warning=FALSE, message=FALSE)
```

# Aims

- Prepare temporal series of IV for each field-plot 

```{r pkg}
library(here)
library(tidyverse)
library(Kendall)
library(trend)
library(kableExtra)
library(DT)
```


# Prepare data 

- Select data for Pinus field plot
- Extract date of each image
- Format NDVI and EVI values (multiply for scale factor 0.0001; see this [link](https://developers.google.com/earth-engine/datasets/catalog/MODIS_006_MOD13Q1)) 
- Compute statistics (*mean*, *sd*, *se*, *cv*, ...) for each IV indexes groupping by year for each field-plot. 

```{r prepare-data}
raw <- read_csv(here::here("data/dendroadaptamed_iv_mod13q1.csv"))
elev_cat <- read_csv(here::here("data/categories_elevation_site_code.csv"))


# Filter only Pinus field plot 
d <- raw %>%
  filter(str_detect(Specie, "Pinu")) %>%
  mutate(date = as.Date(str_replace_all(substr(`system:index`, 1, 10), "_", "-"),
                        format = "%Y-%m-%d"),
         evi = EVI*0.0001,
         ndvi = NDVI*0.0001) %>%
  dplyr::select(date, lat, long, Specie, site_code, evi, ndvi, doy=DayOfYear)

```


```{r}
iv_yearly <- d %>%
  mutate(year=lubridate::year(date)) %>% 
  dplyr::select(site_code, Specie, year, evi, ndvi) %>% 
  pivot_longer(cols = c("ndvi", "evi"), 
               names_to = 'variable', values_to = 'value') %>% 
  group_by(site_code, Specie, year, variable) %>% 
  summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE), 
            se = sd/sqrt(length(value)),
            cv = sd/mean*100,
            median = median(value, na.rm=TRUE),
            sum = sum(value, na.rm=TRUE),
            min = min(value), 
            max = max(value),
            n = length(value)) %>% 
  mutate(Specie = str_replace_all(Specie, "Pinus_", "P. ")) %>% 
  inner_join(elev_cat)
```

# Summary data

```{r}
nsize_years_gral <- d %>% group_by(site_code, Specie) %>% count() %>% dplyr::select(n) %>% pull() %>% unique()

nsize_years <- d %>% mutate(year = lubridate::year(date)) %>%
  group_by(site_code, Specie, year) %>%
  count() %>% 
  filter(site_code == "PIHAL_NACIMIENTO") %>% dplyr::select(n) %>% pull() %>% unique()

```

How many images are there in total and by year?: 

- For each site there are a total of `r nsize_years_gral` images (Table \@ref(tab:mytab)). 

- All the years have `r max(nsize_years)` images except the year 2000 having `r min(nsize_years)` images. 

```{r, results="asis", echo=FALSE}
d %>% group_by(site_code, Specie) %>% count() %>% 
  DT::datatable(rownames = FALSE)

cat("<table width=100%>", paste0("<caption>",
                      "(#tab:mytab)",
                      #"caption",
                      "Sample size (images number) for each field plot.",
                      "</caption>"),
                      "</table>", sep ="\n")
```

# Compute Temporal trends

We explored the temporal trends for both the annual average (Table \@ref(tab:mk-mean)) and also the standard deviation of the EVI (Table \@ref(tab:mk-sd)) along study-period. For this purpose, we use non-parametric Mann-Kendall test. We also explored the magnitude of the trends using the Theil-Sen's slope estimator. 

Significant but weaker positive trends (p-value < 0.05) were observed for annual EVI mean of the high-elevation sites of *P. nigra* and *P. pinaster* (Table \@ref(tab:mk-mean)). The standard deviation decreased significantly along the study period for the PIPIN_JEREZ_M site, and positively and significant increased for PIHAL_NACIMIENTO site (Table \@ref(tab:mk-sd)). 

```{r plot-evi, fig.cap="Temporal evolution of EVI annual mean."}
cols <- c("low" = "red", "low2" ="orange", "med" = "blue", "high" = "darkgreen")

iv_yearly %>% 
  filter(variable == "evi") %>%  
  ggplot(aes(x=year, y=mean, colour=elev_cat)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se), fill=elev_cat), colour=NA, alpha=.2) +
  geom_line() + 
  #geom_point() + 
  facet_wrap(~Specie, ncol=2) +
  scale_fill_manual(values=cols, name="") +
  scale_colour_manual(values=cols, name="") + 
  theme_bw() +
  ylab("EVI annual mean") + xlab("") +
  theme(
    panel.grid = element_blank(),
    # panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill=NA), 
    strip.text = element_text(face="italic")
  )
```


```{r}
mkevi <- iv_yearly %>% 
  filter(variable == "evi")  %>% 
  ungroup() %>% 
  group_by(site_code,Specie) %>% 
  summarise(across(mean:sd, ~MannKendall(.)$tau, .names ="{.col}_tau"),
            across(mean:sd, ~MannKendall(.)$sl, .names ="{.col}_pvalue_mk"),
            across(mean:sd, ~trend::sens.slope(.)$estimate, .names ="{.col}_senslope"),
            across(mean:sd, ~trend::sens.slope(.)$p.value, .names ="{.col}_pvalue_sen"))

```

```{r mk-mean}
mkevi %>% 
  dplyr::select(Specie, site_code, dplyr::starts_with("mean")) %>% rename_with(.cols=dplyr::starts_with("mean"),
            ~str_replace(., "mean_", "")) %>% 
  kbl(
    digits = c(0,3,4,5,4),
    caption = "Mann-Kendall and Seil temporal trend test for EVI mean") %>% 
    kable_paper("hover", full_width = F)
```


```{r mk-sd}
mkevi %>% 
  dplyr::select(site_code, dplyr::starts_with("sd")) %>% rename_with(.cols=dplyr::starts_with("sd"),
            ~str_replace(., "sd", "")) %>% 
  kbl(
    digits = c(0,3,4,4,4),
    caption = "Mann-Kendall and Seil temporal trend test for anual EVI standard deviation") %>% 
    kable_paper("hover", full_width = F)

```




