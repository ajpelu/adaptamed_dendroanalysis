---
title: "Temporal evolution of IV indexes"
output: workflowr::wflow_html
bibliography: references.bib
cls: ecology-letters.csl
editor_options:
  chunk_output_type: console
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set( 
                      warning=FALSE, message=FALSE)
```

# Aims

- Prepare temporal series of IV for each field-plot 

```{r pkg}
library(here)
library(tidyverse)
library(Kendall)
library(trend)
library(kableExtra)
library(DT)
library(hydroTSM)
source("scripts/aux.R")
cols <- c("low" = "red", "low2" ="orange", "med" = "blue", "high" = "darkgreen")
```


# Prepare data 

- Select data for Pinus field plot
- Extract date of each image
- Format NDVI and EVI values (multiply for scale factor 0.0001; see this [link](https://developers.google.com/earth-engine/datasets/catalog/MODIS_006_MOD13Q1)) 
- Compute statistics (*mean*, *sd*, *se*, *cv*, ...) for each IV indexes groupping by year for each field-plot. 

```{r prepare-data}
raw <- read_csv(here::here("data/dendroadaptamed_iv_mod13q1_2024.csv"))
elev_cat <- read_csv(here::here("data/categories_elevation_site_code.csv"))


# Filter only Pinus field plot 
d_raw <- raw |>
  #filter(str_detect(Specie, "Pinu")) |>
  mutate(date = as.Date(str_replace_all(substr(`system:index`, 1, 10), "_", "-"),
                        format = "%Y-%m-%d"),
         evi = EVI*0.0001,
         ndvi = NDVI*0.0001) |>
  dplyr::select(date, lat, long, Specie, site_code, evi, ndvi)


geodf <- terra::vect( "data/geoinfo/geoinfo_dendro_adaptamed_pinus.shp") |> as.data.frame() |>
  unite("sp_elev", c(sp_code, elev_code), remove = FALSE) |> 
  dplyr::select(sp_elev, elev, site_code) |> 
  separate(sp_elev, into = c("sp_code", "elev_code"), remove = FALSE) 

d <- inner_join(d_raw, geodf)
```


```{r}
iv_yearly <- d |>
  mutate(year=lubridate::year(date)) |> 
  dplyr::select(site_code, Specie, year, evi, ndvi, sp_elev) |> 
  pivot_longer(cols = c("ndvi", "evi"), 
               names_to = 'variable', values_to = 'value') |> 
  group_by(site_code, Specie, year, sp_elev, variable) |> 
  summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE), 
            se = sd/sqrt(length(value)),
            cv = sd/mean*100,
            median = median(value, na.rm=TRUE),
            sum = sum(value, na.rm=TRUE),
            min = min(value), 
            max = max(value),
            n = length(value)) |> 
  mutate(Specie = str_replace_all(Specie, "Pinus_", "P. ")) |> 
  inner_join(elev_cat) |> 
  mutate(season = as.factor("yearly")) |> 
  ungroup() |> 
  separate(sp_elev, into = c("sp_code", "elev_code"), remove = FALSE)
```

# Summary data

```{r}
nsize_years_gral <- d_raw |> group_by(site_code, Specie) |> count() |> dplyr::select(n) |> pull() |> unique()

nsize_years <- d_raw |> mutate(year = lubridate::year(date)) |>
  group_by(site_code, Specie, year) |>
  count() |> 
  filter(site_code == "PIHAL_NACIMIENTO_L") |> dplyr::select(n) |> pull() |> unique()

```

How many images are there in total and by year?: 

- For each site there are a total of `r nsize_years_gral` images (Table \@ref(tab:mytab)). 

- All the years have `r max(nsize_years)` images except the year 2000 having `r min(nsize_years)` images. 

```{r, results="asis", echo=FALSE}
d |> group_by(Specie, elev_code) |> count() |> 
  DT::datatable(rownames = FALSE)

cat("<table width=100%>", paste0("<caption>",
                      "(#tab:mytab)",
                      #"caption",
                      "Sample size (images number) for each field plot.",
                      "</caption>"),
                      "</table>", sep ="\n")
```

# Compute Temporal trends

We explored the temporal trends for both the annual average (Table \@ref(tab:mk-mean)) and also the standard deviation of the EVI (Table \@ref(tab:mk-sd)) along study-period. For this purpose, we use non-parametric Mann-Kendall test. We also explored the magnitude of the trends using the Theil-Sen's slope estimator. 

Significant but weaker positive trends (p-value < 0.05) were observed for annual EVI mean of the high-elevation sites of *P. nigra* and *P. pinaster* (Table \@ref(tab:mk-mean)). The standard deviation decreased significantly along the study period for the PIPIN_JEREZ_M site, and positively and significant increased for PIHAL_NACIMIENTO site (Table \@ref(tab:mk-sd)). 

```{r plot-evi, fig.cap="Temporal evolution of EVI annual mean."}

iv_yearly |> 
  filter(variable == "evi") |>  
  ggplot(aes(x=year, y=mean, colour=elev_code)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se), fill=elev_code), colour=NA, alpha=.2) +
  geom_line() + 
  #geom_point() + 
  facet_wrap(~Specie, ncol=2) +
  scale_fill_manual(values=colours_elev, name="") +
  scale_colour_manual(values=colours_elev, name="") + 
  theme_bw() +
  ylab("EVI annual mean") + xlab("") +
  theme(
    panel.grid = element_blank(),
    # panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill=NA), 
    strip.text = element_text(face="italic")
  )
```


```{r}
mkevi_yearly <- iv_yearly |> 
  filter(variable == "evi")  |> 
  ungroup() |> 
  group_by(site_code, sp_elev, Specie, elev_code, sp_code) |> 
  summarise(across(mean:sd, ~MannKendall(.)$tau, .names ="{.col}_tau"),
            across(mean:sd, ~MannKendall(.)$sl, .names ="{.col}_pvalue_mk"),
            across(mean:sd, ~trend::sens.slope(.)$estimate, .names ="{.col}_senslope"),
            across(mean:sd, ~trend::sens.slope(.)$p.value, .names ="{.col}_pvalue_sen"))

```

```{r mk-mean}
mkevi_yearly |> 
  ungroup() |> 
  dplyr::select(Specie, elev_code, dplyr::starts_with("mean")) |> rename_with(.cols=dplyr::starts_with("mean"),
            ~str_replace(., "mean_", "")) |> 
  kbl(
    digits = c(0,3,4,5,4),
    caption = "Mann-Kendall and Seil temporal trend test for EVI mean") |> 
    kable_paper("hover", full_width = F)
```


```{r mk-sd, eval=FALSE}
mkevi_yearly |> 
  dplyr::select(site_code, dplyr::starts_with("sd")) |> rename_with(.cols=dplyr::starts_with("sd"),
            ~str_replace(., "sd", "")) |> 
  kbl(
    digits = c(0,3,4,4,4),
    caption = "Mann-Kendall and Seil temporal trend test for anual EVI standard deviation") |> 
    kable_paper("hover", full_width = F)
```

# Seasonal analysis 
```{r}
iv_season <- d |> 
  mutate(season = as.factor(hydroTSM::time2season(date, out.fmt="seasons"))) |> 
  mutate(year=lubridate::year(date)) |> 
  dplyr::select(site_code, Specie, year, season, evi, ndvi) |> 
  pivot_longer(cols = c("ndvi", "evi"), 
               names_to = 'variable', values_to = 'value') |> 
  group_by(site_code, Specie, year, season, variable) |> 
  summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE), 
            se = sd/sqrt(length(value)),
            cv = sd/mean*100,
            median = median(value, na.rm=TRUE),
            sum = sum(value, na.rm=TRUE),
            min = min(value), 
            max = max(value),
            n = length(value)) |> 
  mutate(Specie = str_replace_all(Specie, "Pinus_", "P. ")) |> 
  inner_join(geodf) |> 
  ungroup()

```


```{r plot-evi-season, fig.cap="Temporal evolution of EVI seasonal mean."}

bind_rows(iv_season, iv_yearly) |> 
  mutate(season = fct_relevel(season, c("yearly", "winter","spring","summer","autumm"))) |> 
  filter(variable == "evi") |>  
  ggplot(aes(x=year, y=mean, colour=elev_code)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se), fill=elev_code), colour=NA, alpha=.2) +
  geom_line() + 
  #geom_point() + 
  facet_grid(Specie~season) +
  scale_fill_manual(values=colours_elev, name="") +
  scale_colour_manual(values=colours_elev, name="") + 
  theme_bw() +
  ylab("EVI seasonal mean") + xlab("") +
  theme(
    panel.grid = element_blank(),
    # panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill=NA), 
    strip.text = element_text(face="italic")
  )
```


```{r}
mkevi_season <- iv_season |> 
  filter(variable == "evi")  |> 
  ungroup() |> 
  group_by(site_code, Specie, sp_code, elev_code, season) |> 
  summarise(across(mean:sd, ~MannKendall(.)$tau, .names ="{.col}_tau"),
            across(mean:sd, ~MannKendall(.)$sl, .names ="{.col}_pvalue_mk"),
            across(mean:sd, ~trend::sens.slope(.)$estimate, .names ="{.col}_senslope"),
            across(mean:sd, ~trend::sens.slope(.)$p.value, .names ="{.col}_pvalue_sen"))

```


```{r}
mkevi_season |> 
  ungroup() |> 
  dplyr::select(Specie, elev_code, season, dplyr::starts_with("mean")) |>
  rename_with(.cols=dplyr::starts_with("mean"),
            ~str_replace(., "mean_", "")) |> 
  kbl(
    digits = c(0,0,0,3,4,5,4),
    caption = "Mann-Kendall and Seil temporal trend test for EVI mean") |> 
    kable_paper("hover", full_width = F)
```


```{r, eval=FALSE}
mkevi_season |> 
  dplyr::select(site_code, season, dplyr::starts_with("sd")) |> rename_with(.cols=dplyr::starts_with("sd"),
            ~str_replace(., "sd_", "")) |> 
  kbl(
    digits = c(0,0,0,3,4,5,4),
    caption = "Mann-Kendall and Seil temporal trend test for anual EVI standard deviation") |> 
    kable_paper("hover", full_width = F)

```




# Long-term high-spatial resolution Landsat (harmonized)

```{r}
landsat <- read_csv("data/dendroadaptamed_ndvi_landsat_harmonized.csv") |> 
  rename(year = "system:time_start") |> 
  mutate(year = as.numeric(str_remove(year, "Aug 1, "))) |> 
  filter(year != 2023) |> 
  pivot_longer(-year, names_to = "site_code", values_to = "ndvi_landsat") |> 
  inner_join(geodf)
```


```{r}
landsat |>
  ggplot(aes(x = year, y = ndvi_landsat, colour = elev_code)) +
  geom_line() +
  geom_point(size = 1.5) +
  theme_bw() +
  ylab("Annual NDVI (Landast 30-m)") +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(hjust = 0, vjust = 1, margin = margin(-0.05, 0.8, 0, 0)),
    plot.background = element_rect(fill = "transparent"), 
    legend.position = "bottom"
  ) +
    scale_colour_manual(values = colours_elev) +
    scale_fill_manual(values=colours_elev, name="") +
  scale_colour_manual(values=colours_elev, name="") +
  facet_wrap(~sp_code) 
```



# Long-term NDVI (AVHRR)
Vas por aquí !!! 



```{r}
ndvi1km_raw <- read_csv(here::here("data/dendroadaptamed_ndvicsic1km.csv"))
```


```{r}
ndvi1km_yearly <- ndvi1km_raw |> 
 mutate(year=lubridate::year(date)) |> 
  group_by(site_code, Specie, year, elev_cat) |> 
  summarise(mean = mean(ndvi, na.rm = TRUE), 
            sd = sd(ndvi, na.rm = TRUE), 
            se = sd/sqrt(length(ndvi)),
            cv = sd/mean*100,
            median = median(ndvi, na.rm=TRUE),
            sum = sum(ndvi, na.rm=TRUE),
            min = min(ndvi), 
            max = max(ndvi),
            n = length(ndvi)) |> 
  mutate(Specie = str_replace_all(Specie, "Pinus_", "P. "), 
         season = as.factor("yearly")) |> 
  ungroup()

ndvi1km_season <- ndvi1km_raw |> 
  mutate(year=lubridate::year(date)) |> 
  mutate(season = 
           as.factor(hydroTSM::time2season(date, 
                                 out.fmt="seasons"))) |> 
           group_by(site_code, Specie, year, season, elev_cat) |> 
  summarise(mean = mean(ndvi, na.rm = TRUE), 
            sd = sd(ndvi, na.rm = TRUE), 
            se = sd/sqrt(length(ndvi)),
            cv = sd/mean*100,
            median = median(ndvi, na.rm=TRUE),
            sum = sum(ndvi, na.rm=TRUE),
            min = min(ndvi), 
            max = max(ndvi),
            n = length(ndvi)) |> 
  mutate(Specie = str_replace_all(Specie, "Pinus_", "P. ")) |> 
  ungroup()

ndvi1km <- bind_rows(
  ndvi1km_yearly, 
  ndvi1km_season
)
```



```{r ndvi-year, fig.cap="Temporal evolution of NDVI annual mean (dataset = AVHRR)"}

ndvi1km |>  
  mutate(season2 = fct_relevel(season, c("yearly", "winter","spring","summer","autumm"))) |>
  ggplot(aes(x=year, y=mean, colour=elev_cat)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se), fill=elev_cat), colour=NA, alpha=.2) +
  geom_line() + 
  facet_grid(Specie~season2) +
  scale_fill_manual(values=cols, name="") +
  scale_colour_manual(values=cols, name="") + 
  theme_bw() +
  ylab("NDVI seasonal mean") + xlab("") +
  theme(
    panel.grid = element_blank(),
    # panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill=NA), 
    strip.text = element_text(face="italic")
  )
```


```{r}
mkndvi1km <- ndvi1km |> 
  ungroup() |> 
  group_by(site_code,Specie, season) |> 
  summarise(across(mean:sd, ~MannKendall(.)$tau, .names ="{.col}_tau"),
            across(mean:sd, ~MannKendall(.)$sl, .names ="{.col}_pvalue_mk"),
            across(mean:sd, ~trend::sens.slope(.)$estimate, .names ="{.col}_senslope"),
            across(mean:sd, ~trend::sens.slope(.)$p.value, .names ="{.col}_pvalue_sen"))

```


```{r}
mkndvi1km |> 
  dplyr::select(Specie, site_code, season, dplyr::starts_with("mean")) |> rename_with(.cols=dplyr::starts_with("mean"),
            ~str_replace(., "mean_", "")) |> 
  kbl(
    digits = c(0,0,0,3,5,5,4),
    caption = "Mann-Kendall and Seil temporal trend test for NDVI (1km)") |> 
    kable_paper("hover", full_width = F)
```


```{r}
mkndvi1km |> 
  dplyr::select(site_code, season, dplyr::starts_with("sd")) |> rename_with(.cols=dplyr::starts_with("sd"),
            ~str_replace(., "sd_", "")) |> 
  kbl(
    digits = c(0,0,0,3,4,5,4),
    caption = "Mann-Kendall and Seil temporal trend test for seasonal and annual NDVI standard deviation") |> 
    kable_paper("hover", full_width = F)

```


# Correlation NDVI AVHRR (1km) - MODIS (250m)

```{r}
# Select ndvi_modis
ndvi_modis <- bind_rows(iv_yearly, iv_season) |> 
  filter(variable == "ndvi")  |> 
  dplyr::select(site_code, Specie, year, mean_modis = mean, sd_modis = sd, se_modis = se, elev_cat, season)

ndvi_avhrr <- ndvi1km |> 
  dplyr::select(site_code, Specie, year, mean_avhrr = mean, sd_avhrr = sd, se_avhrr = se, elev_cat, season)

ndvi_correla <- inner_join(
  ndvi_modis, ndvi_avhrr) 

ggpubr::ggscatter(ndvi_correla,
    x = "mean_avhrr", y = "mean_modis",
   color = "black", shape = 21, size = 1.5, 
   facet.by = "season",
   add = "reg.line",  
   add.params = list(color = "blue", fill = "lightgray"), 
   conf.int = TRUE, 
   cor.coef = TRUE, 
   cor.coeff.args = list(method = "pearson", 
                         label.x = .5, label.y = .2, 
                         label.sep = "\n"), 
   xlab = "NDVI AVHRR 1km",
   ylab = "NDVI MODIS 250m"
   ) +
  geom_abline(slope=1) + 
  lims(x=c(0,1), y=c(0,1)) 
```

## Sentinel 
```{r}
raw_s2 <- read_csv(here::here("data/dendroadaptamed_sentinel2.csv")) |>
  filter(str_detect(Specie, "Pinu")) |>
  mutate(date = as.Date(str_replace_all(substr(`system:index`, 1, 8), "_", "-"),
                        format = "%Y%m%d")) |> 
  inner_join(elev_cat)


ndvi_s2 <- raw_s2 |> 
  dplyr::select(date, lat, long, Specie, site_code, ndvi=NDVI, elev_cat) |> 
  filter(!is.na(ndvi))

evi_s2 <- raw_s2 |> 
  dplyr::select(date, lat, long, Specie, site_code, evi=EVI, elev_cat) |> 
  filter(!is.na(evi))


ndvi_s2 |> 
  group_by(date, Specie, site_code, elev_cat) |> 
  summarise(mean = mean(ndvi), 
            sd = sd(ndvi, na.rm = TRUE), 
            se = sd/sqrt(length(ndvi))) |> 
  ggplot(aes(x=date, y=mean, colour=elev_cat)) +
  geom_line() + 
  facet_wrap(~Specie, ncol=2) +
  scale_fill_manual(values=cols, name="") +
  scale_colour_manual(values=cols, name="") + 
  theme_bw() 
  
```




