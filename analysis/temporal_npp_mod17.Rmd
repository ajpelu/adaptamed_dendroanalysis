---
title: "Temporal evolution of NPP from MODIS MOD17A3"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set( 
                      warning=FALSE, message=FALSE)
```

# Aims

- Prepare temporal series of yearly NPP for each field-plot, and then compute temporal trends

- Data source: 
  
  - MODIS [MOD17A3HGF](https://developers.google.com/earth-engine/datasets/catalog/MODIS_061_MOD17A3HGF)
  - Spatial resolution: 500 m pixel
  - The MOD17A3HGF V6.1 product provides information about annual Gross and Net Primary Productivity (GPP and NPP) at 500m pixel resolution. Annual NPP is derived from the sum of all 8-day Net Photosynthesis(PSN) products (MOD17A2H) from the given year. The PSN value is the difference of the Gross Primary Productivity (GPP) and the Maintenance Respiration (MR) (GPP-MR).
  - Detailed info [here](https://lpdaac.usgs.gov/documents/972/MOD17_User_Guide_V61.pdf)

```{r pkg}
library(here)
library(tidyverse)
library(tidytext)
library(Kendall)
library(trend)
library(kableExtra)
library(DT)

source("scripts/aux.R")
```


# Prepare data 

- Select data for Pinus field plot
- Extract date of each image
- Format NPP values (multiply for scale factor 0.0001; see this [link](https://developers.google.com/earth-engine/datasets/catalog/MODIS_006_MOD17A3HGF)) 

```{r prepare-data}
# raw_npp <- read_csv(here::here("data/dendroadaptamed_npp_mod17a3_yearly.csv"))
raw_npp <- read_csv(here::here("data/raw/remote_sensing/npp_mod17a3_yearly.csv"))
# elev_cat <- read_csv(here::here("data/categories_elevation_site_code.csv")) 

geodf <- terra::vect( "data/geoinfo/geoinfo_dendro_adaptamed_pinus.shp") |> as.data.frame() |>
  unite("sp_elev", c(sp_code, elev_code), remove = FALSE) |> 
  dplyr::select(sp_elev, elev, site_code) |> 
  separate(sp_elev, into = c("sp_code", "elev_code"), remove = FALSE) 

d <- inner_join(raw_npp, geodf) |> 
  mutate(elev_code = fct_relevel(as.factor(elev_code), c("low2","low","medium","high"))) 


# elev_cat <- elev_cat |> 
#   mutate(elev_cat = fct_relevel(as.factor(elev_cat), c("low2","low","med","high"))) 

dnpp <- d |>
  mutate(date = as.Date(str_replace_all(substr(`system:index`, 1, 10), "_", "-"),
                        format = "%Y-%m-%d"),
         npp = Npp*0.0001*1000) |>
  dplyr::select(date, elev_code, sp_code, sp_elev, npp, npp_qc = Npp_QC) 

```


# Summary data

```{r}
npp_summary <- dnpp |> 
  group_by(sp_code, elev_code, sp_elev) |> 
  summarise(mean = mean(npp, na.rm = TRUE), 
            sd = sd(npp, na.rm = TRUE), 
            se = sd/sqrt(length(npp)),
            cv = sd/mean*100,
            min = min(npp), 
            max = max(npp)) 

```

```{r npp-summary}
npp_summary |> 
  arrange(sp_code, elev_code) |> 
  kbl(
    digits = c(0,0,0,2,2,2,2,2,2),
    caption = "Summary values of the yearly NPP (g C m^-2^ year ^-1^) along the study period (2000-2021) for the study sites.") |> 
    kable_paper("hover", full_width = F)
```


```{r, plot-npp-avg, fig.cap="Comparison of average values of yearly NPP."}

npp_summary |> 
  ggplot(aes(x=elev_code, y=mean, fill=elev_code, colour=elev_code)) + 
  geom_point(size=3) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.3)+
  ylab(expression(NPP~(g~C~m^{-2}~year^{-1}))) + 
  xlab("") + 
  facet_grid(cols=vars(factor(sp_code, levels = c("halepensis", "pinaster", "nigra", "sylvestris"))), scales = "free_x", space = "free_x") +
  scale_fill_manual(values=colours_elev, name="") +
  scale_colour_manual(values=colours_elev, name="") + 
  theme_bw() + 
    theme(
    panel.grid = element_blank(),
    # panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill=NA), 
    strip.text = element_text(face="italic")
  )




```


# Compute Temporal trends

We explored the temporal trends for the NPP annual average (Table \@ref(tab:mk-mean)) along study-period. For this purpose, we use non-parametric Mann-Kendall test. We also explored the magnitude of the trends using the Theil-Sen's slope estimator.  

```{r}
mknpp <- dnpp |> 
  mutate(year = lubridate::year(date)) |> 
  ungroup() |> 
  group_by(sp_code, elev_code, sp_elev) |> 
  summarise(across(npp, ~MannKendall(.)$tau, .names ="{.col}_tau"),
            across(npp, ~MannKendall(.)$sl, .names ="{.col}_pvalue_mk"),
            across(npp, ~trend::sens.slope(.)$estimate, .names ="{.col}_senslope"),
            across(npp, ~trend::sens.slope(.)$p.value, .names ="{.col}_pvalue_sen")) |> 
  arrange(sp_code, elev_code) |> 
  mutate(ypos = 
           case_when(
             elev_code == "low" ~ 1025,
             elev_code == "low2" ~ 1000,
             elev_code == "medium" ~ 1050,
             elev_code == "high" ~ 1075), 
         p_value_string = symnum(npp_pvalue_mk, corr = FALSE,
               cutpoints = c(0,  .001,.01,.05, 1),
               symbols = c("***","**","*",""))) |> 
  mutate(taulabel = paste(expression(tau), "==", paste0('"', round(npp_tau, 2), p_value_string, '"')))

```


Significant but weaker positive trends (p-value < 0.05) were observed for yearly NPP of the medium- and high-elevation sites of *P. sylvestris* (Table \@ref(tab:mk-mean)). 


```{r mk-mean}
mknpp |> 
  dplyr::select(-ypos, -p_value_string, -taulabel) |> 
  kbl(
    digits = c(0,0,0,4,4,4,4),
    caption = "Mann-Kendall and Seil temporal trend test for yearly NPP") |> 
    kable_paper("hover", full_width = F)
```


```{r plot-npp, fig.cap="Temporal evolution of year NPP."}
dnpp |> 
  mutate(year = lubridate::year(date)) |> 
  ggplot(aes(x=year, y=npp, colour=elev_code)) +
  geom_line() + 
  #geom_point() + 
  facet_wrap(~(factor(sp_code, levels = c("halepensis", "pinaster", "nigra", "sylvestris"))),
             nrow = 1) +
  scale_fill_manual(values=colours_elev, name="") +
  scale_colour_manual(values=colours_elev, name="") +
  ylab(expression(NPP~(kg~C~m^{-2}~year^{-1}))) + 
  xlab("") + 
  theme_bw() + 
    theme(
    panel.grid = element_blank(),
    # panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill=NA), 
    strip.text = element_text(face="italic")
  ) +
  geom_text(x = 2002, aes(y = ypos, label = taulabel), data = mknpp, parse = TRUE, show.legend = FALSE, hjust = "left")
```


```{r}
write_csv(mknpp, "data/dendroadaptamed_npp_modis_trend.csv")
write_csv(dnpp, "data/dendroadaptamed_npp_modis.csv")
```


