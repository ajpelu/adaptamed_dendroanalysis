---
title: "Figure: Time series Dendrochronology and Remote Sensing"
output: workflowr::wflow_html
bibliography: references.bib
cls: ecology-letters.csl
editor_options:
  chunk_output_type: console
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10, fig.height = 7
)
```


```{r}
library(tidyverse)

source("scripts/aux.R")
```

```{r}
abi <- read_csv("data/dendroadaptamed_abi.csv") |> 
  rename(mean = IBT_ag_m2) |> 
  mutate(se = NA, sd = NA, variable = "abi")

npp <- read_csv("data/dendroadaptamed_npp_modis.csv") |> 
  rename(mean = npp) |> 
  mutate(se = NA, sd = NA, variable = "npp", year = lubridate::year(date)) |> 
  dplyr::select(-npp_qc, -sp_elev, -date)

evi_landsat <- read_csv("data/dendroadaptamed_iv_landsat.csv") |> 
  filter(iv == "evi") |> 
  dplyr::select(year, sp_code, elev_code, mean, sd, se) |> 
  mutate(variable = "evi_landsat")

evi_modis <- read_csv("data/dendroadaptamed_iv_modis.csv") |> 
  filter(variable == "evi") |> 
  filter(season == "yearly") |> 
  dplyr::select(year, sp_code, elev_code, mean, sd, se) |> 
  mutate(variable = "evi_modis")


df <- bind_rows(
  abi, evi_landsat, evi_modis, npp
)
```

```{r}
mk_evi_landsat <- read_csv("data/dendroadaptamed_iv_modis_trend.csv") |> 
  filter(season == "yearly") |> 
  dplyr::select(sp_code, elev_code, sp_elev, tau = mean_tau, pvalue_mk = mean_pvalue_mk,  senslope = mean_senslope, pvalue_sen= mean_pvalue_sen, ypos, p_value_string, taulabel) |> 
   mutate(variable = "evi_landsat")
  
mk_npp <- read_csv("data/dendroadaptamed_npp_modis_trend.csv") |> 
  rename(tau = npp_tau, 
         pvalue_mk = npp_pvalue_mk,
         senslope = npp_senslope,
         pvalue_sen = npp_pvalue_sen) |> 
  mutate(variable = "npp") |> 
  mutate(ypos2 = case_when(
    ypos == 1000 ~ 800, 
    ypos == 1025 ~ 900, 
    ypos == 1050 ~ 1000, 
    ypos == 1075 ~ 1075)) |> 
  dplyr::select(-ypos) |> rename(ypos = ypos2)


mk_abi <- abi |> 
  unite("sp_elev", c(sp_code, elev_code), remove = FALSE) |> 
  group_by(sp_elev, sp_code, elev_code) |> 
  count() |> 
  dplyr::select(-n) |> 
  mutate(tau = NA, pvalue_mk =NA, senslope = NA, pvalue_sen = NA, 
         ypos =NA, p_value_string = NA, taulabel = NA,
         variable = "abi")

mk <- bind_rows(mk_evi_landsat, mk_npp, mk_abi) |> 
  mutate(variable = fct_relevel(variable, "evi_landsat", "npp", "abi")) |> 
   mutate(elev_code = fct_relevel(elev_code, "low2","low", "medium", "high")) 
```


```{r}

to_label <- as_labeller(c(
 "evi_landsat" = "Annual~EVI[Landsat]", 
 "npp" = "Annual~NPP[MODIS]~(g~C~m^2~year^{-1})",
 "abi" = "ABI~(g~C~m^2~year^{-1})"
), default = label_parsed)


fig_ts <- df |> 
  filter(variable != "evi_modis") |>
  mutate(variable = fct_relevel(variable, "evi_landsat", "npp", "abi")) |> 
  mutate(elev_code = fct_relevel(elev_code, "low2","low", "medium", "high")) |> 
  ggplot(aes(x = year, y = mean, group = elev_code, colour = elev_code)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se), fill=elev_code), colour=NA, alpha=.2) + 
  geom_line() +
  facet_grid(variable~factor(sp_code, levels = c("halepensis", "pinaster", "nigra", "sylvestris")), 
             scales = "free_y", 
             switch = "y", 
             labeller = labeller(variable = to_label)) + 
  scale_colour_manual(values = colours_elev, name = "") +
  scale_fill_manual(values = colours_elev, name="") + 
  theme_bw() +
  ylab("") +  xlab("") + 
  theme(
    panel.grid = element_blank(),
    panel.background = element_blank(),
    strip.text.x = element_text(face = "italic", size = 10),
    strip.text.y = element_text(face = "bold", size = 10),
    strip.background = element_blank(),
    strip.placement = "outside", 
    legend.position = "bottom"
  ) +
  scale_x_continuous(limits = c(1980, 2021), breaks = seq(1950, 2020, by = 10), 
                     sec.axis = dup_axis()) +
  scale_y_continuous(sec.axis = dup_axis()) +
  geom_text(x = 1980, aes(y = ypos, label = taulabel), data = mk, parse = TRUE, show.legend = FALSE, hjust = "left")

```

```{r}
ggsave(
  fig_ts, 
  file = "output/plot_ts_dendro_remote.png",
  dpi = 300,
  width = 12, height = 8
)
```









```{r}

label_landsat <- "Annual~EVI[Landsat]"
label_npp <- "Annual~NPP[MODIS]~(g~C~m^2~year^{-1})"
label_abi <- "ABI~(g~C~m^2~year^{-1})"


abi_npp<- df |> filter(variable %in% c("abi", "npp")) |> 
  pivot_wider(values_from = mean, names_from = variable)

lm_abi_npp <- lm(npp ~ abi, data=abi_npp)

abi_npp |> 
  filter(year > 1999) |> 
  ggplot(aes(x=abi, y = npp, colour = sp_code)) + 
  geom_point(aes(shape = elev_code, fill = sp_code)) +
  geom_abline(slope = 1) +
  scale_colour_manual(values = colours_sp, name = "Species") +
  scale_shape_manual(values = shape_elev, name = "Elevation") +
  scale_fill_manual(values = colours_sp, name = "Species") + 
  theme_bw() 




abi_evi <- df |> 
  filter(variable %in% c("abi", "evi_landsat")) |> 
  dplyr::select(-se, -sd) |> 
  pivot_wider(values_from = mean, names_from = variable) 

lm_abi <- lm(evi_landsat ~ abi, data=abi_evi)

abi_evi |> 
  filter(year > 1999) |> 
  ggplot(aes(x=abi, y = evi_landsat)) + 
  geom_point(aes(shape = elev_code, fill = sp_code, colour = sp_code)) +
  scale_colour_manual(values = colours_sp, name = "Species") +
  scale_shape_manual(values = shape_elev, name = "Elevation") +
  scale_fill_manual(values = colours_sp, name = "Species") + 
  theme_bw() +
  scale_x_continuous(limits = c(0,500)) + 
  scale_y_continuous(limits = c(0,.5)) +
  # geom_abline(slope = coef(lm_abi)[["abi"]], 
  #             intercept = coef(lm_abi)[["(Intercept)"]]) +
  geom_abline(slope = 0.001, colour = "gray") + 
  theme(
    panel.grid = element_blank(), 
    legend.background = element_blank(),
    legend.position = c(.8,.35)
  ) +
  xlab(parse(text=label_abi)) +
  ylab(parse(text=label_landsat)) 


 # stat_cor(label.y = .48, 
 #           aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
 #  ggpubr::stat_regline_equation(label.x = 50, label.y = 0.45,
 #                                formula = y ~ x)
 #  


```


