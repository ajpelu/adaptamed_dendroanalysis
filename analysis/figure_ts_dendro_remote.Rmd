---
title: "Figure: Time series Dendrochronology and Remote Sensing"
output: workflowr::wflow_html
bibliography: references.bib
cls: ecology-letters.csl
editor_options:
  chunk_output_type: console
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10, fig.height = 7
)
```


```{r}
library(tidyverse)

source("scripts/aux.R")
```

## Figure 2

```{r}
abi <- read_csv("data/dendroadaptamed_abi.csv") |> 
  rename(mean = IBT_ag_m2) |> 
  mutate(se = NA, sd = NA, variable = "abi")

npp <- read_csv("data/dendroadaptamed_npp_modis.csv") |> 
  rename(mean = npp) |> 
  mutate(se = NA, sd = NA, variable = "npp", year = lubridate::year(date)) |> 
  dplyr::select(-npp_qc, -sp_elev, -date)

evi_landsat <- read_csv("data/dendroadaptamed_iv_landsat.csv") |> 
  filter(iv == "evi") |> 
  dplyr::select(year, sp_code, elev_code, mean, sd, se) |> 
  mutate(variable = "evi_landsat")

evi_modis <- read_csv("data/dendroadaptamed_iv_modis.csv") |> 
  filter(variable == "evi") |> 
  filter(season == "yearly") |> 
  dplyr::select(year, sp_code, elev_code, mean, sd, se) |> 
  mutate(variable = "evi_modis")


df <- bind_rows(
  abi, evi_landsat, evi_modis, npp) |> 
  mutate(elev_code = fct_recode(elev_code, `low-Dec` = "low2")) |> 
  mutate(elev_code = fct_relevel(elev_code, "low-Dec","low", "medium", "high"))

```

```{r}
mk_evi_landsat <- read_csv("data/dendroadaptamed_iv_modis_trend.csv") |> 
  filter(season == "yearly") |> 
  dplyr::select(sp_code, elev_code, sp_elev, tau = mean_tau, pvalue_mk = mean_pvalue_mk,  senslope = mean_senslope, pvalue_sen= mean_pvalue_sen, ypos, p_value_string, taulabel) |> 
   mutate(variable = "evi_landsat")
  
mk_npp <- read_csv("data/dendroadaptamed_npp_modis_trend.csv") |> 
  rename(tau = npp_tau, 
         pvalue_mk = npp_pvalue_mk,
         senslope = npp_senslope,
         pvalue_sen = npp_pvalue_sen) |> 
  mutate(variable = "npp") |> 
  mutate(ypos2 = case_when(
    ypos == 1000 ~ 800, 
    ypos == 1025 ~ 900, 
    ypos == 1050 ~ 1000, 
    ypos == 1075 ~ 1075)) |> 
  dplyr::select(-ypos) |> rename(ypos = ypos2)


mk_abi <- abi |> 
  unite("sp_elev", c(sp_code, elev_code), remove = FALSE) |> 
  group_by(sp_elev, sp_code, elev_code) |> 
  count() |> 
  dplyr::select(-n) |> 
  mutate(tau = NA, pvalue_mk =NA, senslope = NA, pvalue_sen = NA, 
         ypos =NA, p_value_string = NA, taulabel = NA,
         variable = "abi")

mk <- bind_rows(mk_evi_landsat, mk_npp, mk_abi) |> 
  mutate(variable = fct_relevel(variable, "evi_landsat", "npp", "abi")) |> 
  mutate(elev_code = fct_recode(elev_code, `low-Dec` = "low2")) |> 
  mutate(elev_code = fct_relevel(elev_code, "low-Dec","low", "medium", "high"))
```


```{r, fig.height=9, fig.width=12}
to_label <- as_labeller(c(
 "evi_landsat" = "Annual~EVI[Landsat]", 
 "npp" = "Annual~NPP[MODIS]~(g~C~m^2~year^{-1})",
 "abi" = "ABI~(g~C~m^2~year^{-1})"
), default = label_parsed)


fig_ts <- df |> 
  filter(variable != "evi_modis") |>
  mutate(variable = fct_relevel(variable, "evi_landsat", "npp", "abi")) |> 
  mutate(elev_code = fct_relevel(elev_code, "low-Dec","low", "medium", "high")) |> 
  ggplot(aes(x = year, y = mean, group = elev_code, colour = elev_code)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se), fill=elev_code), colour=NA, alpha=.2) + 
  geom_line() +
  facet_grid(variable~factor(sp_code, levels = c("halepensis", "pinaster", "nigra", "sylvestris")), 
             scales = "free_y", 
             switch = "y", 
             labeller = labeller(variable = to_label)) + 
  scale_colour_manual(values = colours_elev, name = "") +
  scale_fill_manual(values = colours_elev, name="") + 
  theme_bw() +
  ylab("") +  xlab("") + 
  theme(
    panel.grid = element_blank(),
    panel.background = element_blank(),
    strip.text.x = element_text(face = "italic", size = 10),
    strip.text.y = element_text(face = "bold", size = 10),
    strip.background = element_blank(),
    strip.placement = "outside", 
    legend.position = "bottom"
  ) +
  scale_x_continuous(limits = c(1980, 2021), breaks = seq(1950, 2020, by = 10), 
                     sec.axis = dup_axis()) +
  scale_y_continuous(sec.axis = dup_axis()) +
  geom_text(x = 1980, aes(y = ypos, label = taulabel), data = mk, parse = TRUE, show.legend = FALSE, hjust = "left")


fig_ts
```



```{r}
ggsave(
  fig_ts, 
  file = "output/plot_ts_dendro_remote.png",
  dpi = 300,
  width = 12, height = 8
)
```



## Comparisons among variables
```{r, fig.height=5, fig.width=5}
## Revisar 
label_landsat <- "Annual~EVI[Landsat]"
label_npp <- "Annual~NPP[MODIS]~(g~C~m^2~year^{-1})"
label_abi <- "ABI~(g~C~m^2~year^{-1})"


abi_npp <- df |> filter(variable %in% c("abi", "npp")) |> 
  pivot_wider(values_from = mean, names_from = variable) |> 
  filter(year > 1999) |> 
  filter(!is.na(abi)) |> 
  filter(!is.na(npp))


lm_abi_npp <- lm(npp ~ abi, data=abi_npp)

abi_npp |> 
  filter(year > 1999) |> 
  ggplot(aes(x=npp, y = abi, colour = sp_code)) + 
  geom_point(aes(shape = elev_code, fill = sp_code)) +
  scale_colour_manual(values = colours_sp, name = "Species") +
  scale_shape_manual(values = shape_elev, name = "Elevation") +
  scale_fill_manual(values = colours_sp, name = "Species") + 
  theme_bw() + 
    theme(
    panel.grid = element_blank(), 
    legend.background = element_blank(),
    legend.position = c(.1,.7)
  ) +
  ylab(parse(text=label_abi)) +
  xlab(parse(text=label_npp)) 

# 
# model <- lm(abi ~ npp, data = abi_npp)
# segmented_model <- segmented(model, seg.Z = ~npp)
# 
# seg_preds <- as.vector(predict(segmented_model))
# seg_res <- abi_npp$abi - seg_preds
# 
# 
# abi_npp <- abi_npp |> 
#   rowwise() |> 
#   mutate(seg_preds = predict(segmented_model))
# 
# 
# # Plot the original data with the fitted model
# plot(
#   abi_npp$npp, abi_npp$abi,
#   main = "Piecewise Regression Fit",
#   xlab = "Independent Variable (x)",
#   ylab = "Dependent Variable (y)",
#   col = "blue"
# )
# lines(abi_npp$npp, seg_preds,col = "red", lwd = 2)
# 
# 
# 
# ggg <- data.frame(npp = abi_npp$npp, 
#                   abi = abi_npp$abi)
# ggg$seg = seg_preds


abi_evi <- df |> 
  filter(variable %in% c("abi", "evi_landsat")) |> 
  dplyr::select(-se, -sd) |> 
  pivot_wider(values_from = mean, names_from = variable) 

lm_abi <- lm(evi_landsat ~ abi, data=abi_evi)

abi_evi |> 
  filter(year > 1999) |> 
  ggplot(aes(x=evi_landsat, y = abi)) + 
  geom_point(aes(shape = elev_code, fill = sp_code, colour = sp_code)) +
  scale_colour_manual(values = colours_sp, name = "Species") +
  scale_shape_manual(values = shape_elev, name = "Elevation") +
  scale_fill_manual(values = colours_sp, name = "Species") + 
  theme_bw() +
  scale_y_continuous(limits = c(0,500)) + 
  scale_x_continuous(limits = c(0,.5)) +
  # geom_abline(slope = coef(lm_abi)[["abi"]], 
  #             intercept = coef(lm_abi)[["(Intercept)"]]) +
  # geom_abline(slope = 0.001, colour = "gray") + 
  theme(
    panel.grid = element_blank(), 
    legend.background = element_blank(),
    legend.position = c(0.3,0.8)
  ) +
  xlab(parse(text=label_abi)) +
  ylab(parse(text=label_landsat)) +
  guides(
    shape = guide_legend(
      title = "Elevation", 
      title.position = "top", 
      label.position = "right", 
      nrow = 1
    ),
    colour = guide_legend(
      title = "Species", 
      title.position = "top", 
      label.position = "right", 
      nrow = 1
    ),
    fill = "none" # Remove the fill legend
  ) +
   geom_smooth(method = "lm", aes(fill = sp_code, colour = sp_code), se=FALSE) 

 # stat_cor(label.y = .48, 
 #           aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
 #  ggpubr::stat_regline_equation(label.x = 50, label.y = 0.45,
 #                                formula = y ~ x)
 #  


```


```{r}
npp_evi <- df |> 
  filter(variable %in% c("npp", "evi_landsat")) |> 
  dplyr::select(-se, -sd) |> 
  pivot_wider(values_from = mean, names_from = variable) 


init <- as.data.frame(t(getInitial(npp ~ SSlogis(evi_landsat, Asym, xmid, scal), data = npp_evi)))



npp_evi |> 
  ggplot(aes(x=evi_landsat, y = npp)) + 
  geom_point(aes(shape = elev_code, fill = sp_code, colour = sp_code)) +
  scale_colour_manual(values = colours_sp, name = "Species") +
  scale_shape_manual(values = shape_elev, name = "Elevation") +
  scale_fill_manual(values = colours_sp, name = "Species") + 
  theme_bw() +
  theme(
    panel.grid = element_blank(), 
    legend.background = element_blank(),
  ) +
  ylab(parse(text=label_npp)) +
  xlab(parse(text=label_landsat)) +
  geom_smooth(method = "lm", aes(fill = sp_code, colour = sp_code), se=FALSE, size =.7) +
  geom_smooth(method = "nls", 
              aes(), 
              formula = y~Asym/(1+exp(-(x-xmid)/scal)), 
              se =  FALSE, # this is important 
              method.args =list(start=init,
                                control=nls.control(maxiter=1000)), 
              colour = "black")
```

