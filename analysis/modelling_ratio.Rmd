---
title: "Modelling Ratio ABI:NPP"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
--- 

```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```


```{r, message=FALSE}
library(tidyverse)
library(patchwork)
library(likelihood)
library(kableExtra)
library(patchwork)
source("scripts/aux.R")
```

```{r}
annual_pet <- read_csv("data/dendroadaptamed_spei_climate.csv") |> 
  dplyr::select(sp_elev, year, monthly_pet, monthly_tmed, monthly_prec) |> 
  group_by(sp_elev, year) |>
  summarise(pet = sum(monthly_pet), 
            prec = sum(monthly_prec),
            tmed = mean(monthly_tmed, na.rm = TRUE)) |> 
  rowwise() |> 
  mutate(water_balance = prec - pet)
```


```{r}
ratio <- read_csv("data/dendroadaptamed_ratio_abinpp.csv") |> 
  dplyr::select(year, sp_code, elev_code, sp_elev, ratio_abi_npp = ratio) 

df <- ratio |> 
  inner_join(annual_pet) |> 
  pivot_longer(pet:water_balance, values_to = "mean_climate", 
               names_to = "climate_variable")
```


```{r}
dtmed <- df |> filter(climate_variable == "tmed") |> dplyr::select(rat = ratio_abi_npp, tmed = mean_climate)
```


# Temperature 

$$(ABI:NPP)_i=MR \times g(T_{med}) + \epsilon_i$$
where: 

- $(ABI:NPP)_i$ es el valor del ratio de ABI:NPP para cada sitio y año
- $MR$ es un parámetro que representa el máximo ratio ABI:NPP (adimensional)
- $\epsilon_i$ es el error aleatorio para cada observación $i$ 
- $g(T_{med})$ es una función con valores entre 0 y 1, que depende de la temperatura

Esta $g(T_{med})$ puede tomar diferentes formas (es lo que tenemos que buscar)

Al aumentar la temperatua, se disminuye el ratio, esto es, se distribuye menos cantidad de C a la parte aérea. ¿Que explicación le podemos dar a esto? 

### Funciones propuestas

- Gaussian (**mtrat1**)
$$g(T_{med})=\exp \left[ -\frac{1}{2} \left(\frac{T_{med}-OT_{med}} {b}\right)^2 \right]$$

siendo $OT_{med}$ el valor óptimo de $T_{med}$ al cual ocurre el máximo Ratio $(ABI:NPP)_i$; y $b$ es la desviación estándar o amplitud de la función. 

- Gaussian Extended (**mtrat2**)
$$g(T_{med})=\exp \left[ -\frac{1}{2} \left(\frac{T_{med}-OT_{med}} {b}\right)^a \right]$$
con el parámetro $a$ que permite hacer a la función flexible para ajustar la kurtosis

- Log-normal (**mtrat3**)
$$g(T_{med})=\exp \left[ -\frac{1}{2} \left(\frac{\log{(\frac{T_{med}}{OT_{med}}}) }{b}\right)^2 \right]$$ 

- Logistic (**mtrat4**)

$$g(T_{med})=a + \frac{b}{1+\exp \left(-c \times (T_{med} - d) \right) } $$ 

where, $a$ es el valor de la asíntota inferior; $b$ es la distancia vertical entre la asíntota superior e inferior; $c$ es la la tasa de cambio, y $d$ es la localización del punto de inflexión. 

- Asintótica (**mtrat5**) 

$$g(T_{med})= Asym + \left(R0 - Asym\right) \times \exp(- \exp ^{lrc \times T_{med}})$$ 
siendo $Asym$ el valor de asíntota horizontal; $R0$ el valor de la variable respuesta cuando la $T_{med}$ es cero; y $lrc$ es la tasa de cambio 

```{r}
mtrat1 <- function(MR, OTmed, b)
{
  tmed_effect <- exp(-0.5*((dtmed$tmed - OTmed)/b)^2)
  MR * tmed_effect
}

mtrat2 <- function(MR, OTmed, b, a)
{
  tmed_effect <- exp(-0.5*((dtmed$tmed - OTmed)/b)^a)
  MR * tmed_effect
}

mtrat3 <- function(MR, OTmed, b)
{
  tmed_effect <- exp(-0.5*(log(dtmed$tmed/OTmed)/b)^2)
  MR * tmed_effect
}

# Logistic 
mtrat4 <- function(MR, a, b, c, d)
{
  tmed_effect <- a + b /(1 + exp(- c *( dtmed$tmed - d )))
  MR * tmed_effect
}

mtrat5 <- function(MR, Asym, R0, lrc)
{
  tmed_effect <- Asym + (R0 - Asym)*exp(-exp(lrc)*dtmed$tmed)
  MR * tmed_effect
}


name_models <- data.frame(
  modelo = paste0("mtrat",c(1:5)), 
  name_modelo = c("Gaussian",
                  "Gaussian Extended", 
                  "Log-normal",
                  "Logistic",
                  "Asymptotic")
)
```

The error term in the model 

$$(ABI:NPP)_i=MR \times g(T_{med}) + \epsilon_i$$
is assumed to follows a normal distribution $\epsilon_i \sim \mathcal{N}(0,1)$


```{r}
var=list(mean = "predicted", x = "rat", tmed = "tmed")  
```


```{r} 
## Guassian model 
set.seed(1234)
start <- Sys.time()

# change model 
result_mtrat1 <- anneal(
  model = mtrat1, 
  var = var, 
  source_data = dtmed,
  par = list(MR = 0.7, OTmed = 10.5, b = 1.5),
  par_lo = list(MR = 0, OTmed = 5, b = 0.01),
  par_hi = list(MR = 1, OTmed = 20, b = 5),
  pdf = dnorm,
  dep_var = "rat",
  initial_temp = 5, 
  temp_red = 0.975, 
  max_iter = 50000, 
  show_display = FALSE
)

end <- Sys.time()
time_mtrat1 <- as.numeric(end - start, units = "secs")

result_mtrat1 |> 
  likelihood::write_results("output/models/mtrat1.txt")
```




```{r}
# Gaussian Extended 
set.seed(21)

start <- Sys.time()

# change model 
result_mtrat2 <- anneal(
  model = mtrat2, 
  var = var, 
  source_data = dtmed,
  par = list(MR = 0.7, OTmed = 10, b = 2, a = 2),
  par_lo = list(MR = 0, OTmed = 5, b = 1, a = 2.5),
  par_hi = list(MR = 1, OTmed = 20, b = 5, a = 1.5),
  pdf = dnorm,
  dep_var = "rat",
  initial_temp = 5, 
  temp_red = 0.975, 
  max_iter = 50000, 
  show_display = FALSE
)

end <- Sys.time()
time_mtrat2 <- as.numeric(end - start, units = "secs")

result_mtrat2 |> 
  likelihood::write_results("output/models/mtrat2.txt")

```


```{r}
#Log-normal
set.seed(1234)

# change model 
result_mtrat3 <- anneal(
  model = mtrat3, 
  var = var, 
  source_data = dtmed,
  par = list(MR = 0.7, OTmed = 10.5, b = 1.5),
  par_lo = list(MR = 0, OTmed = 5, b = 0.01),
  par_hi = list(MR = 1, OTmed = 20, b = 5),
  pdf = dnorm,
  dep_var = "rat",
  initial_temp = 5, 
  temp_red = 0.975, 
  max_iter = 50000, 
  show_display = FALSE
)

end <- Sys.time()
time_mtrat3 <- as.numeric(end - start, units = "secs")

result_mtrat3 |> 
  likelihood::write_results("output/models/mtrat3.txt")
```

```{r}
set.seed(1234)

start <- Sys.time()
result_mtrat4 <- anneal(
  model = mtrat4, 
  var = var, 
  source_data = dtmed,
  par = list(MR = 0.7, a = 0, b = 0.5, c = -1, d = 10),
  par_lo = list(MR = 0, a = -.5, b = 1.5, c = -2, d = 0),
  par_hi = list(MR = 1, a = .5, b = 1, c = 2, d = 20),
  pdf = dnorm,
  dep_var = "rat",
  initial_temp = 5, 
  temp_red = 0.975, 
  max_iter = 50000, 
  show_display = FALSE
)

end <- Sys.time()
time_mtrat4 <- as.numeric(end - start, units = "secs")

result_mtrat4 |> 
  likelihood::write_results("output/models/mtrat4.txt")
```

```{r}
## Asymptotic model 
set.seed(1234)

start <- Sys.time()

result_mtrat5 <- anneal(
  model = mtrat5, 
  var = var, 
  source_data = dtmed,
  par = list(MR = 0.7, Asym = 0.1, R0 = 1, lrc = -1),
  par_lo = list(MR = 0, Asym = 0, R0 = 0.5, lrc = -2),
  par_hi = list(MR = 1, Asym = 0.2, R0 = 10, lrc = 0),
  pdf = dnorm,
  dep_var = "rat",
  initial_temp = 5, 
  temp_red = 0.975, 
  max_iter = 50000, 
  show_display = FALSE
)

end <- Sys.time()
time_mtrat5 <- as.numeric(end - start, units = "secs")

result_mtrat5 |> 
  likelihood::write_results("output/models/mtrat5.txt")

```

## Results

```{r}
all_results <-
  mget(
    grep("^result_mtrat", ls(), value = TRUE)
  ) |>
  purrr::imap_dfr(~ MLE_results_format(.x, yvar = "rat"), .id = "modelo") |>
  arrange(aic_cor) |>
  mutate(modelo = str_remove(modelo, "result_"))

all_time <- mget(
  grep("^time_mtrat", ls(), value = TRUE)
) |>
  map_dfr(~ tibble(exec_time_s = .x), .id = "modelo") |>
  mutate(modelo = str_remove(modelo, "time_"))


# compute delta AIC and add computation time
models_results <- all_results |>
  inner_join(all_time) |>
  inner_join(name_models) |>
  relocate(name_modelo, .after = modelo) |> 
  mutate(deltaAIC = dAIC(aic_cor))

models_results |> 
  write_csv("data/models_ratio_tmed_summary.csv")
```


```{r}
models_results |> 
  kbl() |> 
  kable_styling()
```


```{r}
#| fig.height: 10
#| fig.width: 7
prepare_data <- function(x, yvar) {
  x$source_data |> 
    mutate(residuals = !!sym(yvar)  - predicted) |> 
    rename(observed = !!sym(yvar)) 
}

all_data <-
  mget(
    grep("^result_mtrat", ls(), value = TRUE)
  ) |>
  purrr::imap_dfr(~ prepare_data(.x, yvar = "rat"), .id = "modelo") |>
  mutate(modelo = str_remove(modelo, "result_")) |> 
  inner_join(name_models)


p <- all_data |> 
  ggplot(aes(x = predicted, y = observed)) +
  labs(x = "Predicted") + 
  geom_point() +
  geom_abline() + 
  facet_wrap(~modelo, ncol = 1) +
  geom_text(data = models_results, 
            x = .5, 
            y = .25, 
            aes(label = paste("R^2~'='", round(R2, 3), sep="~")), 
            parse = TRUE) +
  geom_text(data = models_results, 
            x = .5, 
            y = .1, 
            aes(label = paste("Slope~'='", round(slope, 4), sep="~")),
            parse = TRUE) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        panel.spacing = unit(0, "lines"), 
        strip.text = element_text(hjust = 0), 
        strip.background = element_rect(fill="white")) 
  


g <- all_data |> 
  ggplot(aes(x = predicted, y = residuals)) +
  labs(x = "Predicted") + 
  geom_point() +
  geom_hline(yintercept = 0) +  
  facet_wrap(~modelo, ncol = 1) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        panel.spacing = unit(0, "lines"), 
        strip.text = element_text(hjust = 0), 
        strip.background = element_rect(fill="white")) +
   scale_y_continuous(position = "right", sec.axis = sec_axis(~., labels = NULL)) 

p + g 
```


## Comparing Ratio ABI:NPP ~ Tmed 
```{r}
#| fig.height: 5 
#| fig.width: 7
colours_combined <- c("mtrat1" = "red", 
                      "mtrat2" = "blue", 
                      "mtrat3" = "green", 
                      "mtrat4" = "black", 
                      "mtrat5" = "darkgoldenrod4")

colours_combined_name <- c("Gaussian" = "red", 
                      "Gaussian Extended" = "blue", 
                      "Log-normal" = "green", 
                      "Logistic" = "black", 
                      "Asymptotic" = "darkgoldenrod4")


ggplot(all_data, 
       aes(x= tmed, y = observed, 
           group = name_modelo, colour = name_modelo)) +
  geom_point(colour="gray") + 
  geom_line(aes(y = predicted)) + 
  xlab("Annual Mean Temperature (ºC)") +
  ylab("ABI:NPP") + 
  theme_bw() +
  theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "bold", size = 14)) +
    scale_colour_manual(values = colours_combined_name, name = "Models")
```


