---
title: "Prepare Climate data"
author: '[Antonio J. PÃ©rez-Luque](https://github.com/ajpelu) <a href="https://orcid.org/0000-0002-1747-0469" target="orcid.widget">
<img alt="ORCID logo" src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" width="16" height="16" /></a>'
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set( 
                      warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse) |> suppressPackageStartupMessages()
library(sf)
library(terra)
library(purrr)
```


```{r}
# Create a custom function to extract the data
extract_climate_data <- function(shapefile, raster_folder_path) {

  shapefile_to_extract <- terra::vect(shapefile)

  # Read the raster files
  files <- list.files(path = raster_folder_path, pattern = ".tif$", full.names = TRUE)

  # Read a raster to compare crs
  r <- terra::rast(files[1])

  # Check projection and transform (project)
  if (crs(r) != crs(shapefile_to_extract)) {
    shapefile_to_extract <- terra::project(shapefile_to_extract, r)
  }

  # Extract all data
  myF <- function(x) {
    terra::extract(terra::rast(x), shapefile_to_extract, xy = TRUE)
  }

  extracted_data <- files |>
    map(myF) |>
    reduce(inner_join)

  return(extracted_data)

}
```

```{r, eval=FALSE}
geo_pinos  <- "data/geoinfo/geoinfo_dendro_adaptamed_pinus.shp"

tmed_path <- "/Users/ajpelu/Desktop/DATA/CLIMA/REDIAM/02_DIARIA/TEMP_MEDIA_DIARIA/InfGeografica/InfRaster/COG/"
tmin_path <- "/Users/ajpelu/Desktop/DATA/CLIMA/REDIAM/02_DIARIA/TEMP_MINIMA_DIARIA/InfGeografica/InfRaster/COG/"
tmax_path <- "/Users/ajpelu/Desktop/DATA/CLIMA/REDIAM/02_DIARIA/TEMP_MAXIMA_DIARIA/InfGeografica/InfRaster/COG/"
prec_path <- "/Users/ajpelu/Desktop/DATA/CLIMA/REDIAM/02_DIARIA/PRECIP_DIARIA/InfGeografica/InfRaster/COG/"

startTime <- Sys.time() 

tmed <- extract_climate_data(geo_pinos, raster_folder_path = tmed_path)
startTime <- Sys.time() 
tmin <- extract_climate_data(geo_pinos, raster_folder_path = tmin_path)
tmax <- extract_climate_data(geo_pinos, raster_folder_path = tmax_path)
prec <- extract_climate_data(geo_pinos, raster_folder_path = prec_path)

endTime <- Sys.time()  
print(endTime - startTime)

write_csv(prec, "data/raw/climate/daily_prec.csv")
write_csv(tmed, "data/raw/climate/daily_tmed.csv")
write_csv(tmax, "data/raw/climate/daily_tmax.csv")
write_csv(tmin, "data/raw/climate/daily_tmin.csv")

saveRDS(prec, file = "data/raw/climate/daily_prec.rds")
saveRDS(tmed, file = "data/raw/climate/daily_tmed.rds")
saveRDS(tmax, file = "data/raw/climate/daily_tmax.rds")
saveRDS(tmin, file = "data/raw/climate/daily_tmin.rds")
```


```{r, eval=FALSE}
prepara_df <- function(x){
  out <- x |>
    pivot_longer(-c("ID","x", "y")) |>
    separate(name, into=c("var", "year", "month", "day", "cog")) |>
    dplyr::select(-cog)
  return(out)
}

mylist <- list(tmax, tmed, tmin, prec)

df <- mylist |>
  map(prepara_df) |>
  reduce(rbind) |> 
  mutate(var = case_when(
    var == "td1" ~ "tmed", 
    var == "td2" ~ "tmin",
    var == "td4" ~ "tmax", 
    var == "p" ~ "prec" 
  )) |> 
  mutate(
    year = as.numeric(year), 
    month = as.numeric(month), 
    day = as.numeric(day)
  )

geodf <- terra::vect(geo_pinos) |> as.data.frame() |>
  rownames_to_column(var = "ID") |>
  mutate(ID = as.numeric(ID)) |> 
  dplyr::select(ID, site_code)

climate <- df |> inner_join(geodf)

saveRDS(climate, "data/dendroadaptamed_climate_daily.rds")
```


