---
title: "Figure: Climate sites "
output: workflowr::wflow_html
bibliography: references.bib
cls: ecology-letters.csl
editor_options:
  chunk_output_type: console
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10, fig.height = 7
)
```


```{r}
library(tidyverse)
library(ggbreak)
library(grid)
library(magick)


source("scripts/aux.R")
```

```{r}
avg_yearly <- read_csv("data/dendroadaptamed_climate_avg_yearly.csv") |> 
  mutate(elev_code = fct_recode(elev_code, `low-D` = "low2")) |> 
  mutate(elev_code = fct_relevel(elev_code, "low-D","low", "medium", "high"))

geodf <- terra::vect( "data/geoinfo/geoinfo_dendro_adaptamed_pinus.shp") |> as.data.frame() |>
  unite("sp_elev", c(sp_code, elev_code), remove = FALSE) |> 
  dplyr::select(sp_elev, elev) |> 
  separate(sp_elev, into = c("sp_code", "elev_code"), remove = FALSE) 
  
```


```{r}
aux <- avg_yearly |> 
  dplyr::select(-annual_sd, -annual_se) |> 
  pivot_wider(names_from = var, values_from = annual_value)


lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(lower_ci)
}

upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(upper_ci)
}

aux_avg <- aux |> 
  pivot_longer(tmed:prec, names_to = "var") |>  
  group_by(sp_code, elev_code, sp_elev, var) |> 
  summarise(
    mean = mean(value, na.rm = TRUE), 
    sd = sd(value, na.rm = TRUE), 
    se = sd / sqrt(length(value)), 
    n = length(value)
  ) |> 
  pivot_wider(values_from = c(mean, sd, se, n), names_from = var)

aux_avg1 <- aux_avg |> 
  mutate(lower_prec = lower_ci(mean = mean_prec, se = se_prec, n = n_prec), 
         upper_prec = upper_ci(mean = mean_prec, se = se_prec, n = n_prec), 
         lower_tmed = lower_ci(mean = mean_tmed, se = se_tmed, n = n_tmed),
         upper_tmed = upper_ci(mean = mean_tmed, se = se_tmed, n = n_tmed),
         ) |> 
  inner_join(geodf) |> 
  rename(prec = mean_prec, 
         tmed = mean_tmed)

```




## Figure 1 v1 
```{r}
ggplot(data = aux, 
       aes(y = tmed, x = prec, colour = sp_code)) +
  geom_point(aes(shape = elev_code, fill=sp_code), size = 1.4, alpha = .4) +
  geom_errorbar(
    data = aux_avg1, aes(y = tmed,
                        ymin = lower_tmed,
                        ymax = upper_tmed, 
                        x = prec),
    linewidth = .7) +
  geom_errorbarh(
    data = aux_avg1, aes(x = prec, 
                         xmin = lower_prec, 
                         xmax = upper_prec, 
                        y = tmed), linewidth = .7) +
  geom_point(data = aux_avg1, 
             aes(x = prec, y = tmed, shape = elev_code, fill = sp_code),
             size = 2.9, color = "black", stroke = 1) +  # Set color to "black" for border
  scale_colour_manual(values = colours_sp, name = "Species",
                      guide = guide_legend(label.theme = element_text(face = "italic"))) +
  scale_shape_manual(values = shape_elev, name = "Elevation") + 
  scale_fill_manual(values = colours_sp, name = "Species", 
                    guide = guide_legend(label.theme = element_text(face = "italic"))) + 
  scale_x_continuous(limits = c(0,2000), 
                     breaks = c(0, 250, 500, 750, 1500, 2000)) + 
  xlab("Annual precipitation (mm)") + 
  ylab("Average annual mean temperature (ºC)") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(colour = "black"),
    panel.border = element_blank(),
    axis.title = element_text(face="plain", colour = "black", size=12),
    axis.text.y=element_text(face="plain", colour = "black", size=11),
    axis.text.x=element_text(face= "plain", colour = "black", size=11),
    axis.ticks = element_line(colour="black", size= 0.3)
  ) + 
  guides(
    fill = guide_legend(title = "Species", 
                        override.aes = list(shape = 19, color = colours_sp)),
    shape = guide_legend(override.aes = list(color = "black", fill = "white"))
  ) +  
  scale_x_cut(breaks = 1000, which=2, scales=c(0.2)) 

```


## Figure 1 v2 
```{r}
img_pines <- magick::image_read("data/image_pinus/pinus_juntos.png")



fig_clima <- ggplot(aux, aes(y = tmed, x = prec, colour = sp_code)) +
  geom_point(aes(shape = elev_code, fill = sp_code), size = 1.4, alpha = .4) +
  geom_errorbar(
    data = aux_avg1, aes(
      y = tmed,
      ymin = lower_tmed,
      ymax = upper_tmed,
      x = prec), linewidth = .8) +
  geom_errorbarh(
    data = aux_avg1, aes(
      xmin = lower_prec,
      xmax = upper_prec,
      y = tmed), linewidth = .8) +
  geom_point(
    data = aux_avg1,
    aes(x = prec, y = tmed, shape = elev_code, fill = sp_code),
    size = 2.9, color = "black", stroke = 1) + # Set color to "black" for border
  scale_colour_manual(values = colours_sp, name = "Species") +
  scale_shape_manual(values = shape_elev, name = "Elevation") +
  scale_fill_manual(values = colours_sp, name = "Species") +
  scale_x_continuous(limits = c(0, 1750), breaks = seq(0, 1750, 250)) +
  xlab("Annual precipitation (mm)") +
  ylab("Average annual mean temperature (ºC)") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    legend.position = c(0.1, 0.15),
    legend.background = element_blank()
    ) +
  guides(
    fill = "none",
    color = "none",
    shape = guide_legend(override.aes = list(color = "black", fill = "white"))) +
  annotation_custom(
  grid::rasterGrob(img_pines), xmin = 750, xmax = 1750, ymin = 13, ymax = 16
) + 
  annotate("text", x=850, y=13, label= "italic(halepensis)", parse = TRUE, size = 3.5) +
  annotate("text", x=1150, y=13, label= "italic(pinaster)", parse = TRUE, size = 3.5) +
  annotate("text", x=1450, y=13, label= "italic(nigra)", parse = TRUE, size = 3.5) +
  annotate("text", x=1700, y=13, label= "italic(sylvestris)", parse = TRUE, size = 3.5)

fig_clima
```


```{r}
ggsave(
  fig_clima, 
  file = "output/plot_clima.png",
  dpi = 300,
  width = 9.5, height = 10,
  units = "cm"
)
```


```{r}

fig_clima_en_mapa <- ggplot(aux, aes(y = tmed, x = prec, colour = sp_code)) +
  geom_point(aes(shape = elev_code, fill = sp_code), size = 1.2, alpha = .4) +
  geom_errorbar(
    data = aux_avg1, aes(
      y = tmed,
      ymin = lower_tmed,
      ymax = upper_tmed,
      x = prec), colour = "black", linewidth = .6) +
  geom_errorbarh(
    data = aux_avg1, aes(
      xmin = lower_prec,
      xmax = upper_prec,
      y = tmed), colour = "black",
    linewidth = .6) +
   geom_point(
    data = aux_avg1,
    aes(x = prec, y = tmed, shape = elev_code, fill = sp_code),
    size = 2, color = "black", stroke = .4) + # Set color to "black" for border
  scale_colour_manual(values = colours_sp, name = "Species") +
  scale_shape_manual(values = shape_elev, name = "Elevation") +
  scale_fill_manual(values = colours_sp, name = "Species") +
  scale_x_continuous(limits = c(0, 1750), breaks = seq(0, 1750, 250)) +
  xlab("Annual precipitation (mm)") +
  ylab("Average annual mean temperature (ºC)") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    legend.position = c(0.15, 0.10),
    legend.background = element_blank(),
    legend.text = element_text(size = 6),
    legend.key.size = unit(.2, "cm"),
    axis.title = element_text(size = 10), 
    axis.text = element_text(size = 8)
    ) +
  guides(
    fill = "none",
    color = "none",
    shape = guide_legend(override.aes = list(color = "black", fill = "white", size = 1.5))) +
  annotation_custom(
  grid::rasterGrob(img_pines), xmin = 750, xmax = 1750, ymin = 13, ymax = 16)
 
#   annotate("text", x=850, y=13, label= "italic(halepensis)", parse = TRUE, size = 3.5) +
#   annotate("text", x=1150, y=13, label= "italic(pinaster)", parse = TRUE, size = 3.5) +
#   annotate("text", x=1450, y=13, label= "italic(nigra)", parse = TRUE, size = 3.5) +
#   annotate("text", x=1700, y=13, label= "italic(sylvestris)", parse = TRUE, size = 3.5)



ggsave(
  fig_clima_en_mapa, 
  file = "output/plot_clima_en_mapa.png",
  dpi = 300,
  width = 9.5, height = 10,
  units = "cm"
)

```


